1. Cambiar en Colaboradores mi "SucursalId" = 1


CREATE TABLE public.tipo_ajustes (
    "TipoAjusteId" numeric NOT NULL PRIMARY KEY,
    "Ajuste" character varying(50) NOT NULL,
    "Movimiento" character varying(2) NOT NULL,
    "Aplica" varchar(7) NOT NULL,
    "AfectaCosto" char(1) NOT NULL CHECK("AfectaCosto" IN ('S','N')),
    "FechaHora" timestamptz DEFAULT CLOCK_TIMESTAMP() NOT NULL,
    "Usuario" varchar(30) DEFAULT user
);

INSERT INTO tipo_ajustes VALUES(1,'INVENTARIO CICLICO','+-','Manual','S',CLOCK_TIMESTAMP(),USER);
INSERT INTO tipo_ajustes VALUES(2,'CAMBIO PRESENTACION','+-','Proceso','N',CLOCK_TIMESTAMP(),USER);
INSERT INTO tipo_ajustes VALUES(3,'INVENTARIO FISICO','+-','Proceso','S',CLOCK_TIMESTAMP(),USER);
INSERT INTO tipo_ajustes VALUES(4,'ADMINISTRATIVO','+-','Manual','S',CLOCK_TIMESTAMP(),USER);



CREATE TABLE public.ajustes_inventario (
    "SucursalId" smallint NOT NULL,
    "CodigoId" integer NOT NULL,
    "FolioId" integer NOT NULL,
    "CodigoBarras" VARCHAR(13) NOT NULL,
    "Fecha" date NOT NULL DEFAULT CURRENT_DATE,
    "CategoriaId" smallint NOT NULL,
    "SubcategoriaId" smallint NOT NULL,
    "TipoAjusteId" smallint NOT NULL,
    "AfectaCosto" char(1) CHECK("AfectaCosto" IN ('S','N')) NOT NULL,
    "UnidadesAjustadas" integer NOT NULL,
    "UnidadesInventarioAntes" smallint NOT NULL,
    "UnidadesInventarioDespues" smallint NOT NULL,
    "CostoCompra" numeric(8,4) NOT NULL,
    "CostoPromedio" numeric(8,4) NOT NULL,
    "PrecioVentaSinImpuesto" numeric(8,2) DEFAULT 0 NOT NULL,
    "PrecioVentaConImpuesto" numeric(8,2) DEFAULT 0 NOT NULL,
    "ColaboradorId" smallint NOT NULL,
    "FechaHora" timestamptz NOT NULL,
    "Usuario" varchar(30)
);

ALTER TABLE ajustes_inventario ADD PRIMARY KEY("SucursalId","CodigoId","FolioId");

ALTER TABLE ajustes_inventario ADD CONSTRAINT "SucursalId_fk" FOREIGN KEY("SucursalId") REFERENCES sucursales("SucursalId");
ALTER TABLE ajustes_inventario ADD CONSTRAINT "CodigoId_fk" FOREIGN KEY("CodigoId") REFERENCES productos("CodigoId");
ALTER TABLE ajustes_inventario ADD CONSTRAINT "Fecha_fk" FOREIGN KEY("Fecha") REFERENCES dim_catalogo_tiempo("Fecha");
ALTER TABLE ajustes_inventario ADD CONSTRAINT "CategoriaId_fk" FOREIGN KEY("CategoriaId") REFERENCES categorias("CategoriaId");
ALTER TABLE ajustes_inventario ADD CONSTRAINT "SubcategoriaId_fk" FOREIGN KEY("CategoriaId","SubcategoriaId") REFERENCES subcategorias("CategoriaId","SubcategoriaId");
ALTER TABLE ajustes_inventario ADD CONSTRAINT "TipoAjusteId_fk" FOREIGN KEY("TipoAjusteId") REFERENCES tipo_ajustes("TipoAjusteId");
ALTER TABLE ajustes_inventario ADD CONSTRAINT "ColaboradorId_fk" FOREIGN KEY("ColaboradorId") REFERENCES colaboradores("ColaboradorId");



DROP VIEW vw_kardex;

CREATE VIEW public.vw_kardex AS
 SELECT 'COMPRAS'::text AS "Movimiento",
    c."FolioId",
    c."UnidadesRecibidas" AS "Unidades",
    c."UnidadesInventarioAntes",
    c."UnidadesInventarioDespues",
    c."CostoCompra",
    c."CostoPromedio",
    c."PrecioVentaSinImpuesto",
    c."PrecioVentaConImpuesto",
    to_char(c."FechaHora", 'yyyy-MM-dd HH24:MI:ss.ms.us'::text) AS "FechaHora",
    c."SucursalId",
    c."CodigoId",
    c."ColaboradorId",
    c."SerialId"
   FROM public.compras c
UNION ALL
 SELECT 'VENTAS'::text AS "Movimiento",
    v."FolioId",
    v."UnidadesVendidas" AS "Unidades",
    v."UnidadesInventarioAntes",
    v."UnidadesInventarioDespues",
    v."CostoCompra",
    v."CostoPromedio",
    v."PrecioVentaSinImpuesto",
    v."PrecioVentaConImpuesto",
    to_char(v."FechaHora", 'yyyy-MM-dd HH24:MI:ss.ms.us'::text) AS "FechaHora",
    v."SucursalId",
    v."CodigoId",
    v."VendedorId" AS "ColaboradorId",
    v."SerialId"
   FROM public.ventas v
   UNION ALL
 SELECT 'AJUSTES INVENTARIO'::text AS "Movimiento",
    ai."FolioId",
    ai."UnidadesAjustadas" AS "Unidades",
    ai."UnidadesInventarioAntes",
    ai."UnidadesInventarioDespues",
    ai."CostoCompra",
    ai."CostoPromedio",
    ai."PrecioVentaSinImpuesto",
    ai."PrecioVentaConImpuesto",
    to_char(ai."FechaHora", 'yyyy-MM-dd HH24:MI:ss.ms.us'::text) AS "FechaHora",
    ai."SucursalId",
    ai."CodigoId",
    ai."ColaboradorId",
    ai."FolioId" AS "SerialId"
   FROM public.ajustes_inventario ai;
